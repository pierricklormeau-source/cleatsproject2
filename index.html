<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurateur de Chaussure Pro</title>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/4.0.0/model-viewer.min.js"></script>
    <style>
        /* Changement ici : on permet le scroll sur le body pour ne pas bloquer le zoom */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #000; color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Zone de la chaussure */
        model-viewer { 
            width: 100%; 
            height: 60vh; 
            background: radial-gradient(circle, #222 0%, #000 100%);
            --poster-color: transparent;
            /* Indispensable pour que le touch mobile fonctionne bien */
            touch-action: none; 
        }

        /* Panneau de contrôle */
        .ui-panel {
            width: 100%; 
            height: 40vh; 
            background: #111;
            border-top: 2px solid #00ffcc;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            box-shadow: 0 -10px 20px rgba(0,0,0,0.5);
            overflow-y: auto; /* Permet de scroller les réglages si besoin */
        }

        .control-block { width: 100%; max-width: 450px; margin-bottom: 15px; }
        .label-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
        label { font-size: 12px; color: #00ffcc; text-transform: uppercase; font-weight: bold; letter-spacing: 1px; }
        .val-txt { font-family: monospace; color: #888; font-size: 12px; }
        input[type="range"] { width: 100%; accent-color: #00ffcc; cursor: pointer; }
        input[type="file"] { background: #222; color: #00ffcc; padding: 10px; border-radius: 5px; width: 100%; border: 1px dashed #444; margin-bottom: 20px; cursor: pointer; }
        .btn-reset { background: transparent; border: 1px solid #444; color: #666; padding: 8px 20px; border-radius: 20px; cursor: pointer; transition: 0.3s; font-size: 11px; margin-top: 5px; }
        .btn-reset:hover { border-color: #fff; color: #fff; }
    </style>
</head>
<body>

    <model-viewer id="shoe" 
        src="https://raw.githubusercontent.com/pierricklormeau-source/cleatsproject2/main/base.glb" 
        camera-controls 
        enable-pan
        shadow-intensity="1.5" 
        exposure="1"
        auto-rotate-delay="3000"
        interaction-prompt="auto"
        interpolation-decay="200">
    </model-viewer>

    <div class="ui-panel">
        <div class="control-block">
            <input type="file" id="upload" accept="image/*">
        </div>

        <div class="control-block">
            <div class="label-row">
                <label>Taille du Logo</label>
                <span class="val-txt" id="v-sc">1.0</span>
            </div>
            <input type="range" id="sc" min="0.1" max="10" step="0.1" value="1">
        </div>

        <div class="control-block">
            <div class="label-row">
                <label>Position Horizontale (X)</label>
                <span class="val-txt" id="v-ox">0.00</span>
            </div>
            <input type="range" id="ox" min="-2" max="2" step="0.005" value="0">
        </div>

        <div class="control-block">
            <div class="label-row">
                <label>Position Verticale (Y)</label>
                <span class="val-txt" id="v-oy">0.00</span>
            </div>
            <input type="range" id="oy" min="-2" max="2" step="0.005" value="0">
        </div>

        <button class="btn-reset" onclick="location.reload()">Réinitialiser</button>
    </div>

    <script type="module">
        const mv = document.querySelector('#shoe');
        const sc = document.querySelector('#sc');
        const ox = document.querySelector('#ox');
        const oy = document.querySelector('#oy');
        const upload = document.querySelector('#upload');

        const updateLogo = () => {
            document.getElementById('v-sc').innerText = sc.value;
            document.getElementById('v-ox').innerText = ox.value;
            document.getElementById('v-oy').innerText = oy.value;

            if (!mv.model) return;

            const material = mv.model.materials[0];
            if (material.pbrMetallicRoughness.baseColorTexture) {
                material.pbrMetallicRoughness.baseColorTexture.setTextureTransform({
                    scale: { u: parseFloat(sc.value), v: parseFloat(sc.value) },
                    offset: { u: parseFloat(ox.value), v: parseFloat(oy.value) }
                });
            }
        };

        upload.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const url = URL.createObjectURL(file);
            const texture = await mv.createTexture(url);
            
            // On force le mode CLAMP pour éviter la répétition
            texture.sampler.setWrapS(33071); 
            texture.sampler.setWrapT(33071);

            if (mv.model) {
                const material = mv.model.materials[0];
                material.pbrMetallicRoughness.baseColorTexture.setTexture(texture);
                
                // On force aussi le mode de mélange pour la transparence du logo
                material.setAlphaMode("BLEND"); 
                
                setTimeout(updateLogo, 100);
            }
        });

        [sc, ox, oy].forEach(input => {
            input.addEventListener('input', updateLogo);
        });
    </script>
</body>
</html>
