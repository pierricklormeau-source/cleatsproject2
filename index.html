<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurateur de Chaussure Final</title>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/4.0.0/model-viewer.min.js"></script>
    <style>
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background-color: #000; color: white; 
            font-family: 'Segoe UI', sans-serif; overflow: hidden; 
        }
        
        /* On retire touch-action: none qui peut parfois bloquer certains navigateurs */
        model-viewer { 
            width: 100%; 
            height: 60vh; 
            background: radial-gradient(circle, #222 0%, #000 100%);
            --poster-color: transparent;
        }

        .ui-panel {
            width: 100%; height: 40vh; background: #111;
            border-top: 2px solid #00ffcc;
            display: flex; flex-direction: column; align-items: center;
            padding: 20px; box-sizing: border-box;
            box-shadow: 0 -10px 20px rgba(0,0,0,0.5);
            overflow-y: auto;
        }

        .control-block { width: 100%; max-width: 450px; margin-bottom: 12px; }
        .label-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        label { font-size: 11px; color: #00ffcc; text-transform: uppercase; font-weight: bold; }
        .val-txt { font-family: monospace; color: #888; font-size: 11px; }
        input[type="range"] { width: 100%; accent-color: #00ffcc; cursor: pointer; }
        input[type="file"] { background: #222; color: #00ffcc; padding: 8px; border-radius: 5px; width: 100%; border: 1px dashed #444; margin-bottom: 15px; }
        .btn-reset { background: transparent; border: 1px solid #444; color: #666; padding: 8px 20px; border-radius: 20px; cursor: pointer; font-size: 11px; }
    </style>
</head>
<body>

    <model-viewer id="shoe" 
        src="https://raw.githubusercontent.com/pierricklormeau-source/cleatsproject2/main/base.glb" 
        camera-controls 
        enable-pan
        min-camera-orbit="auto auto 1%" 
        max-camera-orbit="auto auto 1000%"
        shadow-intensity="2" 
        exposure="1"
        interaction-prompt="when-focused">
    </model-viewer>

    <div class="ui-panel">
        <div class="control-block">
            <input type="file" id="upload" accept="image/*">
        </div>

        <div class="control-block">
            <div class="label-row">
                <label>Taille du Logo</label>
                <span class="val-txt" id="v-sc">1.0</span>
            </div>
            <input type="range" id="sc" min="0.1" max="15" step="0.1" value="1">
        </div>

        <div class="control-block">
            <div class="label-row">
                <label>Position Horizontale (X)</label>
                <span class="val-txt" id="v-ox">0.00</span>
            </div>
            <input type="range" id="ox" min="-1" max="1" step="0.005" value="0">
        </div>

        <div class="control-block">
            <div class="label-row">
                <label>Position Verticale (Y)</label>
                <span class="val-txt" id="v-oy">0.00</span>
            </div>
            <input type="range" id="oy" min="-1" max="1" step="0.005" value="0">
        </div>

        <button class="btn-reset" onclick="location.reload()">Réinitialiser</button>
    </div>

    <script type="module">
        const mv = document.querySelector('#shoe');
        const sc = document.querySelector('#sc');
        const ox = document.querySelector('#ox');
        const oy = document.querySelector('#oy');
        const upload = document.querySelector('#upload');

        const updateLogo = () => {
            document.getElementById('v-sc').innerText = sc.value;
            document.getElementById('v-ox').innerText = ox.value;
            document.getElementById('v-oy').innerText = oy.value;

            if (!mv.model) return;

            // On applique la modif à TOUS les matériaux du modèle
            mv.model.materials.forEach(mat => {
                const texture = mat.pbrMetallicRoughness.baseColorTexture;
                if (texture) {
                    texture.setTextureTransform({
                        scale: { u: 1/parseFloat(sc.value), v: 1/parseFloat(sc.value) },
                        offset: { u: parseFloat(ox.value), v: parseFloat(oy.value) }
                    });
                }
            });
        };

        upload.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const url = URL.createObjectURL(file);
            const texture = await mv.createTexture(url);
            
            // Mode "Sticker" (Pas de répétition)
            texture.sampler.setWrapS(33071); 
            texture.sampler.setWrapT(33071);

            if (mv.model) {
                mv.model.materials.forEach(mat => {
                    // On remplace la texture sur chaque partie du modèle
                    mat.pbrMetallicRoughness.baseColorTexture.setTexture(texture);
                    // On force la transparence
                    mat.setAlphaMode("BLEND");
                });
                setTimeout(updateLogo, 50);
            }
        });

        [sc, ox, oy].forEach(input => input.addEventListener('input', updateLogo));
        
        // On s'assure que les réglages s'appliquent au chargement du modèle
        mv.addEventListener('load', updateLogo);
    </script>
</body>
</html>
