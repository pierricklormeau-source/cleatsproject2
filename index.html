<script type="module">
    const modelViewer = document.querySelector('#shoe-viewer');
    const inputElement = document.querySelector('#image-upload');
    const scaleInput = document.querySelector('#scale');
    const offsetXInput = document.querySelector('#offsetX');
    const offsetYInput = document.querySelector('#offsetY');

    const updateTransform = () => {
        const material = modelViewer.model?.materials[0];
        if (material?.pbrMetallicRoughness.baseColorTexture) {
            const s = parseFloat(scaleInput.value);
            material.pbrMetallicRoughness.baseColorTexture.setTextureTransform({
                scale: { u: s, v: s },
                offset: { u: parseFloat(offsetXInput.value), v: parseFloat(offsetYInput.value) }
            });
        }
    };

    inputElement.addEventListener('change', async (event) => {
        const file = event.target.files[0];
        if (!file) return;
        
        const url = URL.createObjectURL(file);
        const texture = await modelViewer.createTexture(url);
        
        // Force le mode "SANS RÉPÉTITION" (33071 est le code pour CLAMP_TO_EDGE dans WebGL)
        texture.sampler.setWrapS(33071); 
        texture.sampler.setWrapT(33071);

        const material = modelViewer.model.materials[0];
        
        // On applique la texture
        material.pbrMetallicRoughness.baseColorTexture.setTexture(texture);
        
        // Petit hack : on rafraîchit l'affichage pour forcer la prise en compte du Wrap
        updateTransform();
    });

    [scaleInput, offsetXInput, offsetYInput].forEach(i => i.addEventListener('input', updateTransform));
</script>

